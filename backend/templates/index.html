
{% extends 'base.html' %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Daily Bright</h1>
        <p class="text-gray-600">
            Track your daily learnings and receive AI-powered insights to enhance your personal growth journey.
        </p>
    </div>
    
    <div class="space-y-8">
        <div class="bg-white rounded-lg border shadow-sm">
            <div class="p-6">
                <div class="flex items-center gap-2 mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                    </svg>
                    <h2 class="text-2xl font-semibold">Today's Reflection</h2>
                </div>
                <p class="text-sm text-gray-500">{{ today_date }}</p>
            </div>
            
            <form method="post" action="{% url 'add_reflection' %}" class="p-6 pt-0 space-y-4">
                {% csrf_token %}
                <div class="space-y-2">
                    <input 
                        type="text" 
                        name="title"
                        placeholder="What did you learn today? (Title)" 
                        class="w-full px-3 py-2 border border-blue-200 focus:border-blue-400 rounded"
                        required
                    >
                </div>
                
                <div class="space-y-2">
                    <textarea 
                        name="content"
                        placeholder="Describe your learnings, insights or reflections..."
                        class="w-full min-h-[200px] px-3 py-2 border border-blue-200 focus:border-blue-400 rounded"
                        required
                    ></textarea>
                </div>
                
                <div id="feedback-section" class="hidden mt-4 p-3 bg-blue-50 rounded-md border border-blue-100">
                    <div class="flex items-center gap-2 text-sm font-medium text-blue-700 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 3v3m6.366-.366-2.12 2.12M21 12h-3m.366 6.366-2.12-2.12M12 21v-3m-6.366.366 2.12-2.12M3 12h3m-.366-6.366 2.12 2.12"></path>
                        </svg>
                        <span>AI Feedback</span>
                    </div>
                    <p id="feedback-content" class="text-sm text-gray-600"></p>
                </div>
                
                <div class="flex gap-2">
                    <button 
                        type="button" 
                        id="get-feedback-btn"
                        class="px-4 py-2 border border-blue-200 text-blue-600 hover:bg-blue-50 rounded"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 3v3m6.366-.366-2.12 2.12M21 12h-3m.366 6.366-2.12-2.12M12 21v-3m-6.366.366 2.12-2.12M3 12h3m-.366-6.366 2.12 2.12"></path>
                        </svg>
                        Get AI Feedback
                    </button>
                    
                    <button 
                        type="submit" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded flex-grow"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                        Save Reflection
                    </button>
                </div>
            </form>
        </div>
        
        <div class="border-t my-8 border-gray-200"></div>
        
        <div id="entries-section">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center gap-2 mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <polyline points="12 6 12 12 16 14"></polyline>
                </svg>
                Past Reflections
            </h2>
            
            {% if reflections %}
                <div class="grid grid-cols-1 gap-4">
                    {% for reflection in reflections %}
                        <div class="bg-white rounded-lg border shadow-sm hover:shadow-md transition-shadow">
                            <div class="p-4">
                                <div class="flex justify-between items-start">
                                    <h3 class="text-lg font-medium">{{ reflection.title }}</h3>
                                    <form method="post" action="{% url 'delete_reflection' reflection.id %}" onsubmit="return confirm('Are you sure you want to delete this reflection?');" class="inline">
                                        {% csrf_token %}
                                        <button type="submit" class="p-1 text-gray-400 hover:text-red-500">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                                <line x1="6" y1="6" x2="18" y2="18"></line>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                                <div class="flex items-center text-sm text-gray-500 mt-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                        <line x1="16" y1="2" x2="16" y2="6"></line>
                                        <line x1="8" y1="2" x2="8" y2="6"></line>
                                        <line x1="3" y1="10" x2="21" y2="10"></line>
                                    </svg>
                                    {{ reflection.date_created|date:"M d, Y" }}
                                </div>
                            </div>
                            
                            <div class="px-4 pb-4">
                                <p class="text-gray-600 line-clamp-3">
                                    {{ reflection.content }}
                                </p>
                            </div>
                            
                            <div class="border-t px-4 py-2">
                                <button 
                                    class="text-blue-600 hover:text-blue-700 hover:bg-blue-50 px-3 py-1 rounded text-sm"
                                    onclick="toggleExpandEntry(this, '{{ reflection.id }}')"
                                    data-expanded="false"
                                >
                                    Show More
                                </button>
                            </div>
                            
                            <div id="expanded-{{ reflection.id }}" class="hidden px-4 pb-4 pt-2">
                                <div class="mb-4">
                                    <p class="text-gray-600">{{ reflection.content }}</p>
                                </div>
                                
                                {% if reflection.feedback %}
                                    <div class="p-3 bg-blue-50 rounded-md border border-blue-100 mb-3">
                                        <div class="flex items-center gap-2 text-sm font-medium text-blue-700 mb-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M12 3v3m6.366-.366-2.12 2.12M21 12h-3m.366 6.366-2.12-2.12M12 21v-3m-6.366.366 2.12-2.12M3 12h3m-.366-6.366 2.12 2.12"></path>
                                            </svg>
                                            <span>AI Insight</span>
                                        </div>
                                        <p class="text-sm text-gray-600">{{ reflection.feedback }}</p>
                                    </div>
                                {% else %}
                                    <button 
                                        class="px-3 py-1 border border-blue-200 text-blue-600 hover:bg-blue-50 rounded text-sm"
                                        onclick="generateFeedback('{{ reflection.id }}')"
                                        id="feedback-btn-{{ reflection.id }}"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 3v3m6.366-.366-2.12 2.12M21 12h-3m.366 6.366-2.12-2.12M12 21v-3m-6.366.366 2.12-2.12M3 12h3m-.366-6.366 2.12 2.12"></path>
                                        </svg>
                                        Get AI Feedback
                                    </button>
                                    <div id="entry-feedback-{{ reflection.id }}" class="hidden mt-3 p-3 bg-blue-50 rounded-md border border-blue-100">
                                        <div class="flex items-center gap-2 text-sm font-medium text-blue-700 mb-2">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M12 3v3m6.366-.366-2.12 2.12M21 12h-3m.366 6.366-2.12-2.12M12 21v-3m-6.366.366 2.12-2.12M3 12h3m-.366-6.366 2.12 2.12"></path>
                                            </svg>
                                            <span>AI Insight</span>
                                        </div>
                                        <p id="feedback-content-{{ reflection.id }}" class="text-sm text-gray-600"></p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="flex flex-col items-center justify-center py-8 text-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-300 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <h3 class="text-xl font-medium text-gray-700">No reflections yet</h3>
                    <p class="text-gray-500 mt-2 max-w-md">
                        Your past reflections will appear here once you've added them.
                    </p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Handle feedback generation for new entries
    document.getElementById('get-feedback-btn').addEventListener('click', function() {
        const content = document.querySelector('textarea[name="content"]').value;
        
        if (!content || content.length < 20) {
            alert('Please write a more detailed reflection first (at least 20 characters).');
            return;
        }
        
        this.textContent = 'Generating...';
        this.disabled = true;
        
        fetch('/api/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ content })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('feedback-content').textContent = data.feedback;
            document.getElementById('feedback-section').classList.remove('hidden');
            this.textContent = 'Refresh Feedback';
            this.disabled = false;
        })
        .catch(error => {
            alert('Failed to generate feedback. Please try again.');
            this.textContent = 'Get AI Feedback';
            this.disabled = false;
        });
    });
    
    // Function to toggle expanding entry details
    function toggleExpandEntry(button, entryId) {
        const expandedSection = document.getElementById('expanded-' + entryId);
        const isExpanded = button.getAttribute('data-expanded') === 'true';
        
        if (isExpanded) {
            expandedSection.classList.add('hidden');
            button.textContent = 'Show More';
            button.setAttribute('data-expanded', 'false');
        } else {
            expandedSection.classList.remove('hidden');
            button.textContent = 'Show Less';
            button.setAttribute('data-expanded', 'true');
        }
    }
    
    // Function to generate feedback for existing entries
    function generateFeedback(entryId) {
        const button = document.getElementById('feedback-btn-' + entryId);
        button.textContent = 'Generating...';
        button.disabled = true;
        
        fetch('/api/feedback', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({ 
                entryId: entryId,
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('feedback-content-' + entryId).textContent = data.feedback;
            document.getElementById('entry-feedback-' + entryId).classList.remove('hidden');
            button.classList.add('hidden');
        })
        .catch(error => {
            alert('Failed to generate feedback. Please try again.');
            button.textContent = 'Get AI Feedback';
            button.disabled = false;
        });
    }
</script>
{% endblock %}
